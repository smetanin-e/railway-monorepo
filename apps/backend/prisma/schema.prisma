generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

model User {
    id        String   @id @default(uuid())
    firstName String   @map("first_name")
    lastName  String   @map("last_name")
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("Users")
}

model Wagon {
    id              String         @id @default(uuid())
    number          String         @unique
    affiliationType WagonOwnership @map("affiliation_type")
    typeId          String         @map("type_id")
    ownerId         String         @map("owner_id")
    barPackage      Decimal        @map("bar_package") @db.Decimal(10, 3) //тара с бруса (т)
    capacity        Decimal        @db.Decimal(10, 3) //Грузоподъемность (т)
    volume          Decimal        @db.Decimal(10, 3) //Объем (м³)
    createdAt       DateTime       @default(now()) @map("created_at")
    updatedAt       DateTime       @updatedAt @map("updated_at")
    owner           WagonOwner     @relation(fields: [ownerId], references: [id], onDelete: Restrict)
    type            WagonType      @relation(fields: [typeId], references: [id], onDelete: Restrict)
    states          WagonState[]
    trips           Trip[]

    @@index([typeId])
    @@index([ownerId])
    @@map("Wagons")
}

model WagonType {
    id           String @id @default(uuid())
    name         String @unique
    numberPrefix String @map("number_prefix") // Префикс с которого должен начинаться номер вагона. Например: "3" или "34" - 3 или 4

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")
    wagons    Wagon[]

    @@map("Wagon_types")
}

model WagonOwner {
    id        String   @id @default(uuid())
    name      String   @unique
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")
    wagons    Wagon[]

    @@map("Wagon_owners")
}

model CargoOwner {
    id   String @id @default(uuid())
    name String @unique

    // Связь с партиями
    batches Batch[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("Cargo_owners")
}

model Cargo {
    id                String   @id @default(uuid())
    name              String   @unique
    nationalCode      String   @unique @map("national_code") // ГНГ
    internationalCode String   @unique @map("international_code") // ЕГСНГ
    createdAt         DateTime @default(now()) @map("created_at")
    updatedAt         DateTime @updatedAt @map("updated_at")

    batches     Batch[]
    wagonStates WagonState[]

    @@map("Cargos")
}

model Station {
    id          String       @id @default(uuid())
    name        String       @unique
    code        String?      @unique
    type        StationType
    createdAt   DateTime     @default(now()) @map("created_at")
    updatedAt   DateTime     @updatedAt @map("updated_at")
    wagonStates WagonState[]

    // партии, где станция — ОТКУДА
    fromBatches Batch[] @relation("FromStation")

    // партии, где станция — КУДА
    toBatches Batch[] @relation("ToStation")

    @@index([type])
    @@map("Stations")
}

model Trip {
    id String @id @default(uuid())

    wagonId String @map("wagon_id")
    wagon   Wagon  @relation(fields: [wagonId], references: [id])

    batchId String @map("batch_id")
    batch   Batch  @relation(fields: [batchId], references: [id])

    startedAt  DateTime // Равен дате и времени партии входа
    finishedAt DateTime? // Равен дате и времени партии

    status TripStatus @default(ACTIVE)

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    wagonStates WagonState[]

    @@unique([batchId, wagonId])
    @@index([wagonId])
    @@index([batchId])
    @@map("Trips")
}

model WagonState {
    id String @id @default(uuid())

    wagonId String @map("wagon_id")
    wagon   Wagon  @relation(fields: [wagonId], references: [id])

    tripId String @map("trip_id")
    trip   Trip   @relation(fields: [tripId], references: [id])

    cargoId String? @map("cargo_id")
    cargo   Cargo?  @relation(fields: [cargoId], references: [id])

    isEmpty Boolean

    stationId String  @map("station_id")
    station   Station @relation(fields: [stationId], references: [id])

    startedAt DateTime  @map("started_at")
    endedAt   DateTime? @map("ended_at")

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    wagonOperations WagonOperation[]

    @@index([wagonId])
    @@index([tripId])
    @@index([stationId])
    @@index([endedAt])
    @@map("Wagon_states")
}

model OperationType {
    id        String  @id @default(uuid())
    name      String  @unique
    normative Decimal @db.Decimal(10, 3)

    changesState Boolean @default(false)

    category        OperationCategory
    concurrency     OperationConcurrency
    wagonOperations WagonOperation[]

    @@map("Operation_types")
}

model WagonOperation {
    id String @id @default(uuid())

    startedAt DateTime  @map("started_at")
    endedAt   DateTime? @map("ended_at")

    typeId String
    type   OperationType @relation(fields: [typeId], references: [id])

    wagonStateId String
    wagonState   WagonState @relation(fields: [wagonStateId], references: [id])

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("Wagon_operations")
}

model Batch {
    id String @id @default(uuid())

    direction BatchDirection
    type      BatchType

    documentNumber String @map("document_number")

    startedAt DateTime @map("started_at")

    cargoOwnerId String      @map("cargo_owner_id")
    cargoOwner   CargoOwner? @relation(fields: [cargoOwnerId], references: [id])

    cargoId String? @map("cargo_id")
    cargo   Cargo?  @relation(fields: [cargoId], references: [id])

    fromStationId String  @map("from_station_id")
    fromStation   Station @relation("FromStation", fields: [fromStationId], references: [id])

    toStationId String  @map("to_station_id")
    toStation   Station @relation("ToStation", fields: [toStationId], references: [id])

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    //wagonStates WagonState[]
    trips Trip[]

    @@unique([type, documentNumber])
    @@index([direction])
    @@index([type])
    @@map("Batches")
}

enum OperationCategory {
    ACTIVE
    PASSIVE
}

enum OperationConcurrency {
    EXCLUSIVE // блокирует другие
    PARALLEL // допускает параллельность
}

enum StationType {
    INTERNAL
    EXTERNAL
}

enum WagonOwnership {
    OWN // принадлежит вашему предприятию (Имеет номера разных форматов)
    LEASED // арендованный (имеет 8-ми значный номер и зависит от типа вагона)
}

enum BatchDirection {
    INBOUND // входящая
    OUTBOUND // исходящая
}

enum BatchType {
    WAYBILL // по накладной
    ROUTE_SHEET // по вагонному листу
}

enum TripStatus {
    ACTIVE // Активен
    COMPLETED // Завершен
}
